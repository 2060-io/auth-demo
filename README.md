# 2060 Demo Guide for Verifiable Credential Authentication with OpenID Connect (VC-AuthN OIDC)

![2060 logo](https://raw.githubusercontent.com/2060-io/.github/44bf28569fec0251a9367a9f6911adfa18a01a7c/profile/assets/2060_logo.svg)

Verifiable Credential Identity Provider for OpenID Connect. This is an implementation of the [verifiable credential](https://github.com/bcgov/vc-authn-oidc) system for [2060.](https://2060.io/)

## Purpose of the demo
This is a demo for deploying an authentication system with Keycloak using an identity provider. The complete system will allow validation of any credential created for the purpose of enabling authentication and thus permitting access to any required system.

Using a vc auth system for issuing Verifiable Credentials has many benefits:

- **security**: For years, there has been a quest for an identity control method for authenticating users, sensitive data, and other transactions. This implementation aims to achieve an approach to the world envisioned for 2060, providing verifiable credentials that ensure the identity of the credential holder.

A conversational DIDComm service is probably **the most secure way of delivering Verifiable Credentials**.

hen, as soon as you've got you Verifiable Credential, you can use it to identify yourself and access passwordless services.

## Device lost, app uninstalled?

If you loose you cellphone or delete the App, then can restore your Identity by simply re-connecting to the same Registry service, verifying your face, and recover your Verifiable Credential.

## Pre-requisites
- A bash-compatible shell such as [Git Bash](https://git-scm.com/downloads)
- [Docker](https://docs.docker.com/get-docker/)
- Ngrok token (optional, required for local development)
- [Kubernetes](https://kubernetes.io/docs/setup/) (for deployment)

## Try the demo(s)
In this initial demo, we will first approach a deployment in a local environment to validate some of the behaviors that the VC Auth system manages for presenting verifiable credentials generated by 2060
**Note**: Please keep in mind that this is an adaptation of the [VC Auth project](https://github.com/bcgov/vc-authn-oidc), which includes a wide range of configurable options and customizations as desired. Detailed information regarding its configuration can be found within the project itself.

### Setup environment
#### Configuring Ngrok

Each developer must apply for an Ngrok token [here](https://dashboard.ngrok.com/get-started/your-authtoken). Then place the token into the .env-dev file within the docker directory.

```
NGROK_AUTHTOKEN=<your token here>
```

#### Running VC-AuthN

Open a shell in the [docker](docker-dev/) folder and run the following commands:

- `./manage build`: this command will build the controller image. This step is required the first time the project is run, and when dependencies in change in the requirements file(s).
- `./manage start`: this will start the project. Follow the script prompts to select the appropriate runtime options: they will be saved in an `env` file for the next execution.
- To reset everything (including removing container data and selected options in the `env` file) execute `./manage rm`.

A list of all available commands is visible by executing `./manage -h`.

#### Using VC-AuthN
<!-- To use VC-AuthN for development and/or demo purposes, a pre-configured demo app is provided in the [demo/vue](demo/vue/) folder. To start it, execute `docker compose up` from within the `demo/vue` folder. -->

In order to use the VC OIDC authentication, a couple of extra steps are required:

- A requested_credentials configuration needs to be registered with VC-AuthN. To do
  so, the following command can be used to post a configuration requesting a Hologram Wallet chatbot credential:

```bash
curl -X 'POST' \
  'http://localhost:5000/ver_configs/' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "ver_config_id": "phone-number",
  "subject_identifier": "",
  "generate_consistent_identifier": true,
  "proof_request": {
    "name": "Chatbot demo phone number",
    "version": "1.0",
    "requested_attributes": [

      {
        "names": ["phoneNumber"],
        "restrictions": [
          {
            "cred_def_id": "did:web:chatbot-demo.dev.2060.io?service=anoncreds&relativeRef=/credDef/8TsGLaSPVKPVMXK8APzBRcXZryxutvQuZnnTcDmbqd9p"
          }
        ]
      }
    ],
    "requested_predicates": []
  }
}'
```

#### Params

| Name                            | Description                                                                                                                               | Value   |
| ------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- | ------- |
| `ver_config_id`                 | String value responsible for identifying the variable `pres_req_conf_id`, which is sent from the frontend to identify the configuration to apply | `phone-number` |
| `subject_identifier`            | See [here](https://github.com/bcgov/vc-authn-oidc/tree/main/docs#subject-identifer-mapping) for further details.                          |         |
| `include_v1_attributes`         | Optional field defaulting to false. Boolean value responsible for enabling the independent sending of credential                          |         |
| `generate_consistent_identifier`| See [here](https://github.com/bcgov/vc-authn-oidc/tree/main/docs#subject-identifer-mapping) for further details.                          |         |
| `requested_credentials`         | Contains the details on the presentation request                                                                                          |         |
| `credentialDefinitionId`        | It contains the ID of the credential required for authentication                                                                          |         |
| `attributes`                    | This is an array containing all the attributes required for the given credential                                                          |         |


- The demo application is configured to use Keycloak as AIM system. To register keycloak as a client for VC-AuthN, execute the following command in a shell:

```bash
curl -X 'POST' \
  'http://localhost:5000/clients/' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "client_id": "keycloak",
  "client_name": "keycloak",
  "client_secret": "**********",
  "response_types": [
    "code",
    "id_token",
    "token"
  ],
  "token_endpoint_auth_method": "client_secret_basic",
  "redirect_uris": [
    "http://localhost:8880/auth/realms/vc-authn/broker/vc-authn/endpoint"
  ]
}'
```

### Setup Keycloak theme
In this exercise, we are utilizing the theme proposed for Keycloak by 2060. It is crucial to ensure that the appropriate parameters are set in Keycloak's environment variables. Two parameters are provided for its proper functioning: the first one, `KC_HOLOGRAM` (recommended), enables the system to detect the associated identity provider for 2060. Additionally, there is an optional parameter named `KC_HOLOGRAM_AUTH` (optional), which allows us to specify the authentication behavior of the identity provider. This parameter is useful in scenarios where disabling email or VC auth might be required, or simply allowing the normal flow if this is not necessary.
Suggested default values:
- KC_HOLOGRAM: "vc-authn"
- KC_HOLOGRAM_AUTH: "vc"

### Get Chatdemo Credential

Demo service for 2060 testing.

#### Scan the QR code

Click the link for chatbot demo.

![demo](https://chatbot-demo.dev.2060.io/qr?size=300&bcolor=FFFFFF&balpha=1&fcolor=000000&falpha=1)

#### Accept the Invitation
<kbd>
<img src="assets/IMG_7719.png" alt="invitation" border:"1" style="height:500px; border: 1px solid #EEEEEE;"/>
<img src="assets/IMG_7720.png" alt="invitation" style="height:500px; border: 1px solid #EEEEEE;"/>
</kbd>

#### Create the Credential

Go to contextual menu, select `Issue credential` and complete the process by `accept` the offered credential.

<kbd>
<img src="assets/IMG_7721.png" alt="invitation" style="height:500px; border: 1px solid #EEEEEE;"/>
<img src="assets/IMG_7722.png" alt="invitation" style="height:500px; border: 1px solid #EEEEEE;"/>
<img src="assets/IMG_7723.png" alt="invitation" style="height:500px; border: 1px solid #EEEEEE;"/>
</kbd>

### Frontend used
The frontend employed is an example available in [2060](https://github.com/2060-io/dashboard-frontend/tree/dev) for the proper implementation and validation of the system. It is important to bear in mind that the frontend dashboard is designed to manage a service deployment in 2060 that is under construction

